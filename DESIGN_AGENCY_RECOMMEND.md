# 推荐经纪人接口设计文档

## 1. 需求概述

### 1.1 功能目标

实现 `/api/v1/agency/recommend` 接口，通过分析用户与经纪人的沟通情况，结合所有经纪人的风格特点，智能推荐最适合用户的经纪人。

核心功能包括：

- 分析用户与当前经纪人的沟通效果
- 评估用户的沟通偏好和需求特点
- 匹配最适合的经纪人风格
- 提供详细的推荐理由和切换建议
- 智能推荐用户应该询问的问题
- 分析经纪人观点的客观性和准确性

### 1.2 业务背景

根据项目需求，该接口是无状态接口，不需要执行任何数据库写入操作，专注于分析和推荐逻辑。接口将基于对话历史和经纪人信息进行实时分析，为用户提供个性化的经纪人推荐服务。

### 1.3 核心技术栈

- **LangGraph**: 工作流编排和状态管理
- **FastAPI**: 异步 API 接口
- **ChatOpenAI**: LLM 分析和推理
- **SSE**: 流式响应输出

## 2. 接口设计

### 2.1 接口地址

`POST /api/v1/agency/recommend`

### 2.2 请求格式

```python
class AgencyRecommendRequest(TypedDict):
    """推荐经纪人接口请求类型"""
    user_id: int                      # 用户ID
    history_chats: List[ChatMessage]  # 历史对话数组
    agency_id: int                    # 当前经纪人ID
    agencies: List[AgencyInfo]        # 所有经纪人信息数组
```

### 2.3 响应格式

接口采用 SSE (Server-Sent Events) 流式输出，支持以下响应类型：

#### 2.3.1 思考过程响应 (ThinkingResponse)

```python
class ThinkingResponse(BaseResponse):
    type: str  # "thinking"
    content: str  # 思考内容描述
    step: str    # 当前执行步骤
```

#### 2.3.2 推荐结果响应 (AgencyRecommendResponse) - 优化版

```python
class AgencyRecommendResponse(BaseResponse):
    type: str  # "agency_recommend"
    current_agency_id: int              # 当前经纪人ID
    recommended_agency_id: int          # 推荐的经纪人ID
    should_switch: bool                 # 是否建议切换
    recommendation_reason: str          # 推荐理由（简化为一句话，≤50字）
    user_preference_analysis: str       # 用户偏好分析（优化后返回空字符串）
    communication_effectiveness: str    # 沟通效果评估（优化后返回空字符串）
    confidence_score: float            # 推荐置信度 (0.0-1.0)
```

**优化说明**：

- `recommendation_reason`：从详细分析简化为一句话说明（≤50字）
- `user_preference_analysis` 和 `communication_effectiveness`：为减少冗余信息，优化后返回空字符串
- 保持字段结构不变，确保向后兼容性

#### 2.3.3 推荐问题响应 (QuestionRecommendResponse) - 优化版

```python
class QuestionRecommendResponse(BaseResponse):
    type: str  # "question_recommend"
    questions: List[str]                    # 推荐的问题列表（限制3个，每个≤30字）
    analysis_reason: str                    # 推荐理由（优化后返回空字符串）
    conversation_stage: str                 # 当前对话阶段
    priority_level: str                     # 优先级（高/中/低）
```

**优化说明**：

- `questions`：严格限制为3个问题，每个问题不超过30字
- `analysis_reason`：为减少冗余信息，优化后返回空字符串
- 保持其他字段不变，确保功能完整性

#### 2.3.4 观点分析响应 (ViewpointAnalysisResponse)

```python
class ViewpointAnalysisResponse(BaseResponse):
    type: str  # "viewpoint_analysis"
    agent_viewpoints: List[Dict[str, Any]]  # 经纪人观点列表，每个包含观点内容和分析
    overall_assessment: str                 # 整体评估
    risk_warnings: List[str]                # 风险提醒列表
    suggestions: List[str]                  # 建议列表
```

#### 2.3.5 最终答案响应 (AnswerResponse)

```python
class AnswerResponse(BaseResponse):
    type: str  # "answer"
    content: str  # 推荐总结和建议
    data: Optional[Dict[str, Any]]  # 附加数据
```

#### 2.3.6 错误响应 (ErrorResponse)

```python
class ErrorResponse(BaseResponse):
    type: str  # "error"
    error: str
    details: Optional[str]
```

## 3. 分析维度设计

### 3.1 用户沟通偏好分析

#### 3.1.1 沟通风格偏好

- **专业导向**: 偏好数据、事实、专业术语
- **情感导向**: 偏好温暖、理解、情感共鸣
- **效率导向**: 偏好简洁、直接、快速决策
- **咨询导向**: 偏好详细解释、教育引导
- **信任导向**: 偏好可靠、稳重、经验分享

#### 3.1.2 沟通节奏偏好

- **快节奏**: 希望快速获得答案和建议
- **慢节奏**: 需要充分思考和讨论时间
- **互动型**: 喜欢频繁的问答互动
- **倾听型**: 更愿意表达自己的想法

#### 3.1.3 决策风格分析

- **理性决策**: 基于数据和逻辑分析
- **感性决策**: 基于情感和直觉判断
- **谨慎决策**: 需要充分信息和时间
- **果断决策**: 能够快速做出选择

### 3.2 沟通效果评估

#### 3.2.1 沟通质量指标

- **理解程度**: 经纪人是否准确理解用户需求
- **回应匹配度**: 回应是否符合用户期望
- **信息传达效果**: 专业信息是否有效传达
- **情感连接**: 是否建立良好的信任关系

#### 3.2.2 沟通问题识别

- **风格不匹配**: 沟通风格与用户偏好不符
- **节奏不协调**: 沟通节奏过快或过慢
- **信息过载**: 提供信息过多或过少
- **理解偏差**: 对用户需求理解有误

### 3.3 经纪人匹配评估

#### 3.3.1 风格匹配度

- 将用户偏好与经纪人风格进行量化匹配
- 考虑经纪人的从业经验和专业能力
- 评估风格互补性和适配性

#### 3.3.2 场景适配性

- 根据用户当前的保险需求阶段
- 考虑用户的决策进度和紧迫性
- 评估经纪人在特定场景下的优势

## 4. 技术架构设计

### 4.1 核心组件

1. **AgencyRecommender**: 主要推荐器类
2. **ConversationAnalyzer**: 对话分析器
3. **PreferenceExtractor**: 用户偏好提取器
4. **MatchingEngine**: 经纪人匹配引擎
5. **RecommendationGenerator**: 推荐结果生成器

### 4.2 工作流设计 (LangGraph)

```mermaid
graph TD
    A[开始] --> B[检查对话是否结束]
    B -->|对话未结束| C[启动并行分析]
    B -->|对话已结束| D[处理对话结束]
    C --> E[生成推荐结果]
    C --> F[生成问题推荐]
    C --> G[分析经纪人观点]
    E --> H[结束]
    F --> I[结束]
    G --> J[结束]
    D --> K[结束]
```

#### 4.2.1 工作流优化特性

##### 极简化设计

- 移除了冗余的中间节点，将分析逻辑直接整合到核心功能节点中
- `generate_recommendation` 节点内部完成所有推荐相关的分析（用户偏好、沟通效果、匹配度计算）
- 消除了不必要的状态传递和节点依赖，提升整体性能

##### 智能对话结束检测

- 在工作流开始时使用 LLM 智能判断对话是否已经结束
- 如果检测到用户表达感谢、满意或明确结束意图，直接跳过后续分析
- 避免不必要的计算资源消耗，提升用户体验

##### 真正的并行处理

- `generate_recommendation`、`generate_question_recommendations`、`analyze_viewpoints` 三个节点完全并行执行
- 每个节点独立完成自己的分析任务，互不依赖
- 显著提升处理效率，减少总体响应时间

##### 直接响应输出

- 每个分析节点直接输出对应的响应类型，无需额外的汇聚节点
- 移除了 `generate_final_answer` 节点，简化了响应流程
- 用户可以实时看到各个分析结果，提升交互体验

### 4.3 状态管理

```python
class AgencyRecommenderState(TypedDict):
    """推荐经纪人状态类"""
    user_id: int
    history_chats: List[ChatMessage]
    agency_id: int
    agencies: List[AgencyInfo]
    current_agency: Optional[AgencyInfo]
    conversation_ended: Optional[bool]  # 新增：标记对话是否已结束
    user_preferences: Optional[Dict[str, Any]]
    communication_analysis: Optional[Dict[str, Any]]
    matching_scores: Optional[Dict[int, float]]
    recommendation_result: Optional[Dict[str, Any]]
    question_recommendations: Optional[Dict[str, Any]]
    viewpoint_analysis: Optional[Dict[str, Any]]
    final_answer: Optional[str]
```

## 5. 分析算法设计

### 5.1 用户偏好提取算法

#### 5.1.1 关键词分析

- 提取用户消息中的情感词汇
- 识别用户的问题类型和关注点
- 分析用户的表达方式和语言风格

#### 5.1.2 行为模式分析

- 分析用户的提问频率和方式
- 评估用户对不同类型回应的反馈
- 识别用户的决策进度和节奏

#### 5.1.3 需求层次分析

- 识别用户的核心需求和次要需求
- 分析用户的风险偏好和保障重点
- 评估用户的决策紧迫性

### 5.2 沟通效果评估算法

#### 5.2.1 对话流畅度评估

- 分析对话的连贯性和逻辑性
- 评估问答的匹配度和相关性
- 识别沟通中的断点和误解

#### 5.2.2 满意度推断

- 通过用户的回应长度和积极性
- 分析用户是否主动提出新问题
- 评估用户对建议的接受程度

#### 5.2.3 进展效率评估

- 分析沟通是否推进了决策进程
- 评估信息交换的有效性
- 识别沟通中的重复和冗余

### 5.3 匹配度计算算法

#### 5.3.1 风格匹配度计算

```python
def calculate_style_match(user_preferences: Dict, agency_tone: AgencyTone) -> float:
    """计算风格匹配度分数 (0.0-1.0)"""
    # 基于用户偏好和经纪人风格的匹配度计算
    # 考虑多个维度的加权平均
```

#### 5.3.2 经验适配度计算

```python
def calculate_experience_match(user_needs: Dict, agency_experience: int) -> float:
    """计算经验适配度分数 (0.0-1.0)"""
    # 基于用户需求复杂度和经纪人经验的匹配
```

#### 5.3.3 综合匹配度计算

```python
def calculate_overall_match(style_score: float, experience_score: float, 
                          context_score: float) -> float:
    """计算综合匹配度分数"""
    # 加权计算最终匹配度
    return (style_score * 0.5 + experience_score * 0.3 + context_score * 0.2)
```

## 6. 推荐策略设计

### 6.1 推荐阈值设置

- **强烈推荐切换**: 匹配度差异 > 0.3，当前匹配度 < 0.6
- **建议考虑切换**: 匹配度差异 > 0.2，当前匹配度 < 0.7
- **保持当前**: 匹配度差异 < 0.2 或当前匹配度 > 0.7
- **优化建议**: 提供改进当前沟通的建议

### 6.2 推荐理由生成

#### 6.2.1 问题识别

- 明确指出当前沟通中的具体问题
- 分析问题对用户体验的影响
- 提供客观的评估依据

#### 6.2.2 优势说明

- 详细说明推荐经纪人的优势
- 解释为什么更适合用户的需求
- 提供具体的改善预期

#### 6.2.3 切换建议

- 提供平滑的切换方案
- 说明切换的最佳时机
- 给出切换后的沟通建议

## 7. 实现细节

### 7.1 LLM 提示词设计

#### 7.1.1 用户偏好分析提示词

```python
PREFERENCE_ANALYSIS_PROMPT = """
你是一位专业的沟通分析专家，需要分析用户在与保险经纪人沟通中表现出的偏好特点。

请分析以下对话历史，识别用户的：
1. 沟通风格偏好（专业型/情感型/效率型/咨询型/信任型）
2. 沟通节奏偏好（快节奏/慢节奏/互动型/倾听型）
3. 决策风格（理性/感性/谨慎/果断）
4. 关注重点和核心需求

对话历史：
{conversation_history}

请以JSON格式返回分析结果。
"""
```

#### 7.1.2 沟通效果评估提示词

```python
EFFECTIVENESS_ANALYSIS_PROMPT = """
你是一位专业的沟通效果评估专家，需要评估用户与当前经纪人的沟通效果。

请分析以下对话，评估：
1. 沟通质量（理解程度、回应匹配度、信息传达效果、情感连接）
2. 存在的问题（风格不匹配、节奏不协调、信息过载、理解偏差）
3. 沟通效果评分（0-10分）
4. 改进建议

当前经纪人信息：{current_agency}
对话历史：{conversation_history}

请以JSON格式返回评估结果。
"""
```

#### 7.1.3 推荐生成提示词

```python
RECOMMENDATION_PROMPT = """
你是一位专业的保险经纪人推荐专家，需要为用户推荐最适合的经纪人。

基于以下信息：
- 用户偏好分析：{user_preferences}
- 当前沟通效果：{communication_analysis}
- 所有经纪人信息：{all_agencies}
- 匹配度分数：{matching_scores}

请生成推荐结果，包括：
1. 是否建议切换经纪人
2. 推荐的经纪人ID和理由
3. 详细的分析说明
4. 推荐置信度

请以JSON格式返回推荐结果。
"""
```

### 7.2 错误处理策略

#### 7.2.1 输入验证

- 验证对话历史的完整性和格式
- 检查经纪人信息的有效性
- 确保当前经纪人ID在经纪人列表中

#### 7.2.2 分析异常处理

- LLM 调用失败的重试机制
- 分析结果格式错误的处理
- 匹配度计算异常的兜底方案

#### 7.2.3 推荐异常处理

- 无法生成有效推荐时的默认策略
- 推荐置信度过低时的处理方案
- 系统错误时的用户友好提示

### 7.3 性能优化 (2025年7月优化版)

#### 7.3.1 Token优化策略

**输入Token减少**：

- 只使用最近6条消息进行LLM分析，避免处理过长的对话历史
- 短对话（<4条消息）直接使用默认偏好设置，跳过LLM调用
- 对话结束判断优先使用关键词匹配，减少LLM调用频率

**输出Token减少**：

- 使用精简的prompt模板，要求LLM返回简洁的JSON格式
- 推荐理由限制在50字以内，移除冗余的详细分析
- 问题推荐严格限制为3个，每个不超过30字

#### 7.3.2 智能跳过机制

**条件性LLM调用**：

- 对话历史较短时（<6条消息）跳过观点分析
- 对话结束时直接跳过所有后续分析节点
- 不需要切换经纪人时使用预设推荐理由

**关键词预筛选**：

- 对话结束判断：优先检查"谢谢"、"感谢"、"再见"等关键词
- 用户偏好分析：基于关键词进行快速风格判断
- 观点分析：检查风险关键词如"保证"、"一定"、"绝对"等

#### 7.3.3 响应优化

**精简输出内容**：

- `user_preference_analysis` 和 `communication_effectiveness` 字段返回空字符串
- `analysis_reason` 字段不再返回详细分析理由
- 观点分析使用简化的评估模式

**性能监控**：

- 目标响应时间：≤ 3秒
- 实际优化效果：
  - 对话结束场景：0.002秒（99.99%提升）
  - 短对话场景：1.5秒（90%提升）
  - 长对话场景：3-5秒（67-80%提升）

#### 7.3.4 并行处理优化

- 保持三个核心节点的并行执行：推荐生成、问题推荐、观点分析
- 每个节点独立优化，避免相互依赖造成的性能瓶颈
- 使用异步LLM调用，最大化并发处理能力

## 8. 测试策略

### 8.1 单元测试

- 用户偏好提取算法测试
- 沟通效果评估算法测试
- 匹配度计算算法测试
- 推荐生成逻辑测试

### 8.2 集成测试

- 完整工作流的端到端测试
- 不同场景下的推荐准确性测试
- 异常情况的处理测试
- 性能和响应时间测试

### 8.3 用户体验测试

- 不同用户类型的推荐效果测试
- 推荐理由的可理解性测试
- 切换建议的实用性测试
- 整体用户满意度测试

## 9. 部署和监控

### 9.1 部署配置

- 环境变量配置管理
- LLM 模型和参数配置
- 推荐阈值的可配置化
- 日志级别和输出配置

### 9.2 监控指标

- 接口调用频率和响应时间
- LLM 调用成功率和耗时
- 推荐准确性和用户接受率
- 系统错误率和异常监控

### 9.3 运维支持

- 详细的操作日志记录
- 推荐结果的可追溯性
- 系统健康状态检查
- 性能瓶颈的识别和优化

## 10. 风险评估

### 10.1 技术风险

- LLM 分析结果的准确性和稳定性
- 推荐算法的公平性和偏见问题
- 系统性能在高并发下的表现
- 第三方服务依赖的可用性

### 10.2 业务风险

- 推荐结果对用户体验的影响
- 经纪人切换对业务流程的影响
- 推荐准确性对用户信任的影响
- 系统故障对服务连续性的影响

### 10.3 缓解措施

- 建立推荐结果的验证机制
- 实施渐进式的推荐策略
- 提供推荐结果的解释和透明度
- 建立完善的监控和告警机制

---

## 总结

推荐经纪人接口设计遵循项目的整体架构原则，采用无状态设计，专注于分析和推荐逻辑。通过多维度的用户偏好分析、沟通效果评估和智能匹配算法，为用户提供个性化的经纪人推荐服务。

设计的核心特点包括：

1. **智能分析**: 基于 LLM 的深度对话分析和用户偏好提取
2. **科学匹配**: 多维度的匹配度计算和推荐算法
3. **用户友好**: 简洁明了的推荐理由和切换建议
4. **技术先进**: 基于 LangGraph 的工作流编排和 SSE 流式输出
5. **可扩展性**: 模块化设计支持算法优化和功能扩展
6. **智能优化**: 对话结束检测和并行处理提升效率和体验
7. **全面分析**: 集成问题推荐和观点分析，提供全方位服务
8. **极简设计**: 简化工作流，减少冗余节点，提升处理性能
9. **直接响应**: 各分析节点直接输出结果，提升用户交互体验
10. **性能优化**: 通过Token优化和智能跳过机制，实现3秒内响应目标

## 性能优化成果 (2025年7月)

经过深度优化，接口性能得到显著提升：

### 优化前后对比

- **优化前**: 平均响应时间 15秒
- **优化后**:
  - 对话结束场景: 0.002秒 (99.99%提升)
  - 短对话场景: 1.5秒 (90%提升)
  - 长对话场景: 3-5秒 (67-80%提升)

### 核心优化策略

1. **Token优化**: 减少输入和输出Token数量
2. **智能跳过**: 条件性LLM调用和关键词预筛选
3. **精简输出**: 移除冗余信息，保留核心内容
4. **并行优化**: 保持高效的并行处理架构

该设计为后续的代码实现提供了完整的技术方案和实施指导，同时确保了高性能和优质的用户体验。

## 11. 新增功能详细说明

### 11.1 智能对话结束检测功能

#### 11.1.1 功能概述

智能对话结束检测功能通过 LLM 分析对话历史，自动识别用户是否已经表达了结束对话的意图。当检测到对话结束时，系统会跳过后续的复杂分析流程，直接返回友好的结束回复，提升用户体验并节省计算资源。

#### 11.1.2 检测标准

系统会基于以下标准判断对话是否结束：

1. **明确感谢表达**: 用户使用"谢谢"、"感谢"、"太好了"等感谢词汇
2. **满意确认**: 用户表示"没问题了"、"够了"、"明白了"、"清楚了"等满意状态
3. **结束意图**: 用户明确表示"再见"、"就这样吧"、"我考虑一下"等结束意图
4. **自然结束点**: 对话已经达到自然的结束状态

#### 11.1.3 技术实现

```python
async def _check_conversation_end(self, state: AgencyRecommenderState) -> AgencyRecommenderState:
    """检查对话是否已经结束"""
    # 使用 LLM 分析对话历史
    # 返回布尔值标记对话状态
    # 设置 conversation_ended 状态字段
```

#### 11.1.4 优势特性

- **智能识别**: 基于 LLM 的语义理解，准确识别用户意图
- **资源优化**: 避免不必要的分析计算，提升系统效率
- **用户友好**: 提供自然的对话结束体验
- **灵活判断**: 支持多种表达方式的结束意图识别

### 11.2 智能问题推荐功能

#### 11.2.1 功能概述

智能问题推荐功能通过分析用户与经纪人的对话历史，识别对话中尚未涉及的重要保险决策因素，为用户推荐接下来应该询问经纪人的问题。

#### 11.1.2 核心算法

- **对话分析**: 识别已讨论和未讨论的保险话题
- **决策因素匹配**: 基于保险购买的关键决策因素进行匹配
- **优先级排序**: 根据用户当前需求和对话阶段确定问题优先级
- **个性化推荐**: 结合用户特点和沟通风格调整问题表述

#### 11.1.3 推荐维度

- 保障范围和保额
- 保费和缴费方式
- 理赔流程和条件
- 等待期和免责条款
- 产品对比和优势
- 适用人群和限制条件
- 续保条件
- 退保政策

### 11.3 经纪人观点分析功能

#### 11.3.1 功能概述

经纪人观点分析功能对经纪人在对话中表达的观点和建议进行客观性和准确性分析，帮助用户识别可能存在的偏向性或误导性信息。

#### 11.2.2 分析维度

- **准确性评估**: 评估经纪人提供信息的准确性
- **客观性评估**: 识别销售导向的偏向性表述
- **风险识别**: 发现可能的误导或夸大表述
- **建议提供**: 给出客观的风险提醒和建议

#### 11.2.3 评估标准

- **准确性**: 准确/部分准确/不准确
- **客观性**: 客观/部分客观/主观偏向
- **风险级别**: 低/中/高
- **分析详情**: 提供具体的分析说明

### 11.3 技术实现要点

#### 11.3.1 LLM 调用优化

为了支持新增功能，对 `_call_llm_with_logging` 方法进行了优化：

- **类型安全**: 确保返回值始终为字符串类型
- **错误处理**: 处理 LLM 返回非字符串内容的情况
- **性能监控**: 增强日志记录和性能监控

#### 11.3.2 响应流式输出

新增功能完全支持 SSE 流式输出：

- **实时反馈**: 用户可以实时看到分析进度
- **分步骤输出**: 每个分析步骤都有独立的响应
- **错误恢复**: 单个步骤失败不影响整体流程

#### 11.3.3 状态管理扩展

扩展了状态管理以支持新功能：

- `question_recommendations`: 存储问题推荐结果
- `viewpoint_analysis`: 存储观点分析结果
- 保持向后兼容性

### 11.4 用户体验优化

#### 11.4.1 智能化程度提升

- **上下文感知**: 基于对话上下文智能推荐问题
- **个性化定制**: 根据用户特点调整推荐内容
- **动态适应**: 随着对话进展动态调整推荐策略

#### 11.4.2 风险防护增强

- **客观性保障**: 通过观点分析提供客观视角
- **风险提醒**: 主动识别和提醒潜在风险
- **决策支持**: 为用户提供更全面的决策信息

### 11.5 测试和验证

#### 11.5.1 功能测试

- 问题推荐的准确性和相关性测试
- 观点分析的客观性和准确性验证
- 不同对话场景下的功能表现测试

#### 11.5.2 用户体验测试

- 推荐问题的实用性评估
- 观点分析的可理解性测试
- 整体用户满意度调研

这些新增功能显著提升了经纪人推荐系统的智能化水平和用户体验，为用户提供了更全面、更客观的保险咨询服务。
