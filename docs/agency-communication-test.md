# AgencyCommunicator 交互式测试工具

## 概述

`test_agency_communication.py` 是一个交互式命令行测试程序，用于测试 `AgencyCommunicator` 类的功能。该程序提供了完整的保险经纪人沟通体验，支持多种经纪人风格，并能智能判断支付时机。

## 功能特性

- **✅ 5种经纪人风格**: 专业严谨、亲和友善、热情积极、咨询顾问、可靠信赖
- **✅ 独立会话管理**: 每次启动重置数据，确保测试独立性
- **✅ 智能支付判断**: 自动识别最佳支付时机
- **✅ 彩色输出**: 支持彩色终端显示（可选）
- **✅ 完整错误处理**: 友好的错误提示和异常处理
- **✅ 交互式界面**: 直观的命令行操作体验

## 启动测试程序

```bash
python test_agency_communication.py
```

## 基本命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `help` | 显示帮助信息 | `help` |
| `agencies` | 显示所有可用经纪人 | `agencies` |
| `switch <id>` | 切换到指定经纪人 | `switch 2` |
| `current` | 显示当前经纪人信息 | `current` |
| `chat <message>` | 与经纪人对话 | `chat 我想了解重疾险` |
| `history` | 查看对话历史 | `history` |
| `clear` | 清空对话历史 | `clear` |
| `reset` | 重置会话（新session_id） | `reset` |
| `status` | 显示当前状态 | `status` |
| `quit/exit` | 退出程序 | `quit` |

## 预设经纪人

程序预设了5个不同风格的经纪人：

### 1. 张专业 (ID: 1) - 专业严谨型

- **特点**: 语言正式，逻辑清晰，使用总分结构
- **适用**: 高端客户、复杂产品咨询
- **回答长度**: 150-200字

### 2. 李亲和 (ID: 2) - 亲和友善型  

- **特点**: 口语化表达，使用表情符号，多段回应
- **适用**: 普通消费者、初次接触保险的用户
- **特殊功能**: 回答自动切分成多条消息

### 3. 王热情 (ID: 3) - 热情积极型

- **特点**: 充满活力，主动预测用户问题
- **适用**: 促销活动、限时优惠产品
- **特殊功能**: 主动引导后续问题

### 4. 陈顾问 (ID: 4) - 咨询顾问型

- **特点**: 简洁冷淡，回答不超过100字
- **适用**: 企业客户、专业咨询
- **回答风格**: 机械、高效

### 5. 刘信赖 (ID: 5) - 可靠信赖型

- **特点**: 诚实透明，高情商同理心
- **适用**: 敏感客户、高价值产品
- **特殊功能**: 即使用户拒绝也保持友好

## 使用示例

### 基础对话流程

```bash
> agencies                          # 查看所有经纪人
> switch 2                          # 切换到李亲和（友善型）
> chat 我想了解重疾险               # 开始对话
> chat 保费大概多少钱？             # 继续询问
> chat 谢谢你的介绍                 # 表达感谢（可能触发支付流程）
```

### 测试不同风格

```bash
> switch 1                          # 专业严谨型
> chat 请详细介绍重疾险的保障范围
> switch 3                          # 热情积极型  
> chat 我对保险不太了解
> switch 4                          # 咨询顾问型
> chat 企业团险有什么方案？
```

### 会话管理

```bash
> history                           # 查看对话历史
> clear                             # 清空历史
> reset                             # 重置会话
> status                            # 查看当前状态
```

## 响应类型说明

程序会显示不同类型的响应：

### 🤔 思考过程 (ThinkingResponse)

显示 AI 的处理步骤，如"正在验证经纪人信息..."

### 💬 经纪人回答 (AnswerResponse)  

显示经纪人的具体回复内容

### 💳 支付流程 (PaymentResponse)

当满足支付条件时，显示支付引导信息

### ❌ 错误信息 (ErrorResponse)

显示错误类型和详细信息

## 支付流程触发条件

系统会根据以下5个条件判断是否进入支付流程：

1. **✅ 购买意向明确**: 用户明确表达购买意愿
2. **✅ 疑虑已解答**: 主要问题得到回答
3. **✅ 对话充分**: 至少进行3轮对话
4. **✅ 问题完结**: 没有重要的未解决问题
5. **✅ 感谢表达**: 用户表达感谢（如"谢谢"、"太好了"等）

## 环境配置

### 必需配置

```bash
# 设置 OpenAI API 配置
export AI_INSUR_OPENAI_API_KEY="your_api_key_here"
export AI_INSUR_OPENAI_BASE_URL="https://api.openai.com/v1"  # 可选
export AI_INSUR_OPENAI_MODEL="gpt-4"  # 可选，默认 gpt-3.5-turbo
```

### 可选依赖

```bash
# 安装 colorama 以获得彩色输出（推荐）
pip install colorama

# 安装 readline 以获得更好的命令行体验（通常已预装）
pip install readline
```

## 故障排除

### 常见问题

**Q: 程序启动失败，提示配置验证失败**
A: 检查环境变量配置，确保设置了 `AI_INSUR_OPENAI_API_KEY`

**Q: 没有彩色输出**
A: 安装 colorama：`pip install colorama`

**Q: 经纪人回应很慢**
A: 检查网络连接和 OpenAI API 可用性

**Q: 切换经纪人失败**
A: 确保使用正确的经纪人ID（1-5）

### 调试模式

如果遇到问题，可以查看详细的日志输出：

```bash
# 设置日志级别为 DEBUG
export AI_INSUR_LOG_LEVEL=DEBUG
python test_agency_communication.py
```

## 数据清理

程序具有完善的数据清理机制：

- **✅ 启动时重置**: 每次启动都会清空会话数据
- **✅ 退出时清理**: 程序退出时自动清理所有数据
- **✅ 独立会话**: 与其他测试程序完全隔离

## 扩展功能

### 添加新经纪人

可以在 `_init_preset_agencies()` 方法中添加新的经纪人：

```python
{
    "agency_id": 6,
    "name": "新经理",
    "tone": AgencyTone.PROFESSIONAL,
    "experience_years": 7
}
```

### 自定义配置

可以修改以下配置：

- 会话超时时间
- 最大历史消息数
- 不同风格的回答长度限制

## 注意事项

1. **API 费用**: 程序会调用 OpenAI API，请注意使用费用
2. **网络要求**: 需要稳定的网络连接访问 OpenAI 服务
3. **测试独立性**: 每次启动都会重置数据，确保测试结果不受影响
4. **中文支持**: 程序完全支持中文输入输出

---

**提示**: 建议在测试前先阅读 `DESIGN_AGENCY_COMMUNICATION.md` 了解完整的设计思路和技术架构。
