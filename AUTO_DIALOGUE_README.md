# AI自动化对话测试系统

## 概述

这是一个完全自动化的AI对话测试系统，用于测试保险对话中的对抗性场景。系统包含两个AI角色：

- **经纪人AI**: 扮演保险经纪人，使用误导性话术推销产品
- **用户AI**: 扮演保险用户，基于智能建议进行回应

## 文件说明

### 主要程序

1. **`test_agency_assistant_auto.py`** - 自动化对话测试程序
   - 两个AI自动进行20轮对话
   - 实时显示意图分析和对话建议
   - 自动记录对话到日志文件

2. **`view_auto_dialogue.py`** - 日志查看器
   - 查看生成的对话日志
   - 支持搜索和简化显示
   - 格式化显示意图分析和建议

### 日志文件

- 位置: `logs/auto_dialogue_YYYYMMDD_HHMMSS.json`
- 多次测试时: `logs/auto_dialogue_YYYYMMDD_HHMMSS_testN.json`
- 包含完整的对话内容、意图分析、建议和回应

## 使用方法

### 1. 启动自动化对话

```bash
python test_agency_assistant_auto.py
```

启动后使用以下命令：

- `broker [test_num] [turns]` - 开始自动化AI对话
  - `test_num`: 测试次数（默认1）
  - `turns`: 每次对话回合数（默认20）
  - 示例: `broker 3 10` - 进行3次测试，每次10回合
- `status` - 显示当前状态
- `history` - 查看对话历史
- `reset` - 重置会话
- `help` - 显示帮助信息
- `quit` - 退出程序

### 2. 查看对话日志

```bash
# 查看最新的日志文件
python view_auto_dialogue.py

# 查看指定的日志文件
python view_auto_dialogue.py logs/auto_dialogue_20241201_143022.json

# 只显示对话内容（简化版）
python view_auto_dialogue.py --simple

# 搜索特定关键词
python view_auto_dialogue.py --search "保费"

# 列出所有日志文件
python view_auto_dialogue.py --list
```

## 功能特性

### 经纪人AI策略

经纪人AI会使用以下策略进行误导性推销：

1. **开场白**: 强调优惠和低价
2. **需求挖掘**: 引导用户关注风险
3. **产品介绍**: 夸大产品优势
4. **促成**: 制造紧迫感
5. **异议处理**: 淡化风险
6. **客户见证**: 提供虚假保证

### 用户AI回应

用户AI基于智能建议系统进行回应：

1. **意图识别**: 分析经纪人话术的真实意图
2. **风险提醒**: 识别潜在的风险点
3. **提问建议**: 生成针对性的问题
4. **智能回应**: 基于建议生成用户回应

### 对话流程

```
经纪人AI → 意图分析 → 对话建议 → 用户AI回应
    ↓           ↓           ↓           ↓
  误导话术   识别意图    风险提醒    智能回应
```

## 日志格式

生成的日志文件包含以下信息：

```json
{
  "session_info": {
    "user_id": 1,
    "session_id": 1,
    "start_time": "2024-12-01T14:30:22",
    "end_time": "2024-12-01T14:35:45",
    "test_index": 0,
    "total_rounds": 20
  },
  "conversation": [
    {
      "round": 1,
      "timestamp": "2024-12-01T14:30:25",
      "broker_message": "您好！我是超级重疾险的专属顾问...",
      "intent_analysis": {
        "讨论主题": ["重疾险"],
        "涉及术语": ["保费", "优惠"],
        "涉及产品": ["重疾险"],
        "经纪人阶段性意图识别": ["开场白"],
        "经纪人本句话意图识别": ["产品介绍"],
        "用户当下需求": ["了解产品"]
      },
      "suggestions": {
        "reminders": {
          "key_points": ["经纪人提到了重疾险相关内容"],
          "potential_risks": ["可能存在销售误导风险"]
        },
        "questions": [
          "可以详细说明一下这个产品的具体内容吗？",
          "能否介绍一下相关的理赔流程和条件？",
          "这个产品有什么需要特别注意的限制或风险吗？"
        ]
      },
      "user_response": "您好，我想了解一下这个重疾险的具体保障内容..."
    }
  ]
}
```

## 环境要求

确保已设置以下环境变量：

```bash
export AI_INSUR_DEEPSEEK_API_KEY="your_deepseek_api_key"
export AI_INSUR_QWEN_API_KEY="your_qwen_api_key"
```

## 示例输出

### 自动化对话示例

```
🧪 第 1/3 次测试
======================================================================

🔄 第 1/10 轮对话
============================================================

🤵 经纪人AI: 您好！我是超级重疾险的专属顾问。我们这款产品现在有特别优惠，首年保费只要99元，您感兴趣吗？

🧠 执行智能分析...
✅ 意图分析完成
✅ 对话建议生成完成
✅ 用户AI回应生成完成

🤖 用户AI: 您好，我想了解一下这个重疾险的具体保障内容，以及后续的保费变化情况。

📈 进度: 10.0% (1/10)

✅ 第 1 次测试完成，共 10 轮对话
⏳ 等待3秒后开始下一次测试...
```

### 日志查看示例

```
📊 会话信息:
──────────────────────────────────────────────────
  用户ID: 1
  会话ID: 1
  开始时间: 2024-12-01T14:30:22
  结束时间: 2024-12-01T14:35:45
  最大轮次: 20
  实际轮次: 20

📈 对话摘要:
──────────────────────────────────────────────────
  总轮次: 20
  第一轮时间: 2024-12-01T14:30:25
  最后一轮时间: 2024-12-01T14:35:42
```

## 注意事项

1. **对抗性测试**: 这是一个对抗性测试系统，观察AI如何识别和应对误导性话术
2. **自动停止**: 对话会在20轮后自动停止，也可以手动中断
3. **日志保存**: 所有对话都会自动保存到日志文件，便于后续分析
4. **依赖关系**: 确保RAG系统已正确设置，包括向量数据库和API密钥

## 故障排除

### 常见问题

1. **API密钥错误**: 确保设置了正确的API密钥
2. **RAG系统未初始化**: 运行 `python util/preprocess_pits_data.py` 初始化向量数据库
3. **日志文件权限**: 确保程序有权限创建和写入logs目录

### 调试命令

```bash
# 测试RAG功能
python test_agency_assistant.py
# 然后输入: test_rag

# 查看系统状态
python test_agency_assistant_auto.py
# 然后输入: status
```

## 扩展功能

可以基于这个系统进行以下扩展：

1. **更多产品类型**: 在BrokerAI中添加更多保险产品
2. **更复杂的话术**: 实现更复杂的销售策略
3. **对话分析**: 添加对话质量评估和分析功能
4. **批量测试**: 支持批量运行多个对话测试 